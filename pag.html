<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="pag.css">
	<link rel="stylesheet" href="jquery.highlight-within-textarea.css">
	</link>
	<link rel="stylesheet" href="jquery-ui.css">
	</link>
	<link rel="stylesheet" href="bootstrap.css">
	</link>
	<title>Document</title>
</head>

<body>
	<div class="wrapper">
		<!-- <textarea spellcheck="false">vou fazer um teste agui de nobo</textarea> -->
		<textarea spellcheck="false"></textarea>
	</div>
	<script src="jquery.min.js"></script>
	<script src="jquery-ui.js"></script>
	<script src="jquery.highlight-within-textarea.js"></script>
	<script src="bootstrap.js"></script>
	<script>

		let palavrasSafe = [];
		let palavraClicada = [];

		let highlightConfig = [];

		$('textarea').highlightWithinTextarea({
			highlight: highlightConfig
		});


		$('textarea').on('input', function (event) {
			console.log('O usuário digitou algo!');

			let tempo
			clearTimeout(tempo);
    		tempo = setTimeout(destacarPalavras, 2000);

		});

		async function consultaApiCorretor() {
			return new Promise((resolve, reject) => {
				let texto = $('textarea').val();
				console.log('texto')							
				console.log(texto)

				$.ajax({
					url: 'https://api.languagetoolplus.com/v2/check',
					type: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'accept': 'application/json'
					},
					data: {
						text: texto,
						language: 'pt-br',
						enabledOnly: false
					},
					datatype: 'json',
					success: function (data) {
						let arrayMensagens = [];
						let erros = data.matches;

						erros.forEach(x => {
							let mensagem = {
								mensagem: x.message,
								indexInicio: x.offset,
								indexFim: x.offset + x.length,
								sugestoes: x.replacements
							};
							arrayMensagens.push(mensagem);
						});
						palavrasSafe = arrayMensagens
						resolve(arrayMensagens);
					},
					error: function (xhr, status, error) {
						console.error(error);
						reject(error);
					}
				});
			});
		}


		async function destacarPalavras() {

			let resultadoApi = await consultaApiCorretor();
			console.log('resultadoApi')
			console.log(resultadoApi)

			let highlightConfig = [];

			for (let i = 0; i < resultadoApi.length; i++) {
				highlightConfig.push({
					highlight: [resultadoApi[i].indexInicio, resultadoApi[i].indexFim],
					className: 'red'
				});
			}

			$('textarea').highlightWithinTextarea({
				highlight: highlightConfig
			});
		}


		$(document).on('click', '.btn-sugestao', function () {
			let palavraNova = $(this).text();
			let texto = $('textarea').val();
			let indiceInicio = palavraClicada[0];
			let indiceFim = palavraClicada[1];

			let textoNovo = substituirPalavraPorIndice(texto, indiceInicio, indiceFim, palavraNova)
			$('textarea').val(textoNovo)
			$('.tooltip-custom').remove();

			palavrasSafe = palavrasSafe.filter(item => item.indexInicio !== indiceInicio);
			destacarPalavras()

		});

		$('textarea').click(function (e) {

			palavrasSafe.forEach(x => {
				let indiceInicial = x.indexInicio;
				let indiceFinal = x.indexFim;
				console.log('indiceInicio ' + indiceInicial + ' indiceFinal ' + indiceFinal)
				let texto = $(this).val();
				let indiceClique = $(this).prop('selectionStart');

				if (indiceClique >= indiceInicial && indiceClique <= indiceFinal) {
					console.log('Clique dentro do intervalo permitido');

					// Remove qualquer tooltip existente
					$('.tooltip-custom').remove();

					let quantidadeSugestoes = 10;
					let listaSugestoes = Object.keys(x.sugestoes.slice(0, quantidadeSugestoes)).map(key => x.sugestoes[key].value);

					let botoesSugestao = '';

					listaSugestoes.forEach(y => {
						console.log(y)
						botoesSugestao += `<button type="button" class="btn-sugestao">${y}</button>`;
					});

					// Cria o tooltip e adiciona ao body
					var tooltip = $('<div class="tooltip-custom">' +
						`<div class="tooltip-descricao">${x.mensagem}.</div>` +
						'<div class="tooltip-sugestoes">' + botoesSugestao + '</div>' +
						'</div>'
					);
					palavraClicada = [indiceInicial, indiceFinal]
					console.log(palavraClicada)
					$('body').append(tooltip);

					// Calcula a posição e mostra o tooltip
					var posicaoTextArea = $(this).offset();
					tooltip.css({
						top: e.pageY + 10, // Posiciona abaixo do clique
						left: e.pageX - (tooltip.width() / 2), // Centraliza horizontalmente
						position: 'absolute',
						display: 'block',
						'z-index': 1000
					});

					// Torna o tooltip arrastável
					tooltip.draggable();
				} else {
					//palavraClicada = []
					console.log(palavraClicada)
					//$('.tooltip-custom').remove();
				}
			})
		});

		function substituirPalavraPorIndice(texto, indiceInicio, indiceFim, novaPalavra) {

			let parteAntes = texto.substring(0, indiceInicio);
			let parteDepois = texto.substring(indiceFim);

			console.log('parteAntes')
			console.log(parteAntes)
			console.log('parteDepois')
			console.log(parteDepois)

			return parteAntes + novaPalavra + parteDepois;
		}
		

	</script>
</body>

</html>